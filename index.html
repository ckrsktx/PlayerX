<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>90s Retro Player Offline</title>
<link rel="manifest" href="manifest.json">
<style>
body {margin:0;background:teal;font-family:Tahoma,sans-serif;display:flex;justify-content:center;align-items:center;flex-direction:column;height:100vh;}
.player {width:350px;background:#c0c0c0;border:2px solid #000;border-radius:4px;box-shadow:inset -2px -2px #808080,inset 2px 2px #fff;display:flex;flex-direction:column;padding:10px;}
.titlebar {background:navy;color:#fff;font-weight:bold;padding:2px 6px;font-size:14px;margin-bottom:6px;}
.display {display:flex;align-items:center;gap:8px;background:#000;color:#0f0;padding:6px;font-family:monospace;height:60px;overflow:hidden;margin-bottom:6px;}
.cover {width:40px;height:40px;border:1px solid #333;background:#111 center/cover no-repeat;flex-shrink:0;}
.texts {display:flex;flex-direction:column;overflow:hidden;}
.texts .title {font-size:15px;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.texts .artist {font-size:12px;font-style:italic;color:#0aa;}
.texts .year {font-size:11px;color:#777;}
.controls {display:flex;justify-content:space-between;margin:8px 0;}
button {width:50px;height:28px;background:#e0e0e0;border:2px solid #000;border-radius:2px;font-weight:bold;cursor:pointer;box-shadow:inset -1px -1px #808080,inset 1px 1px #fff;}
button:active {box-shadow:inset 1px 1px #808080,inset -1px -1px #fff;}
.progress {width:100%;height:6px;background:#808080;border:1px solid #000;margin:5px 0 10px 0;cursor:pointer;}
.fill {width:0%;height:100%;background:#00f;}
.playlist {height:150px;background:#fff;border:1px inset #000;overflow-y:auto;font-size:13px;margin-top:5px;}
.playlist div {padding:3px 6px;cursor:pointer;}
.playlist div.active {background:navy;color:#fff;}
.lyrics-box {width:350px;height:150px;background:#111;color:#0f0;padding:10px;overflow-y:auto;margin-top:5px;border:1px solid #000;font-size:12px;white-space:pre-wrap;}
.lyrics-box::-webkit-scrollbar { width: 0; }
.lyrics-box { -ms-overflow-style: none; scrollbar-width: none; }
</style>
</head>
<body>
<div class="player">
  <div class="titlebar">üéµ 90s Retro Player Offline</div>
  <div class="display">
    <div class="cover" id="cover"></div>
    <div class="texts">
      <div class="title" id="title">Carregando...</div>
      <div class="artist" id="artist"></div>
      <div class="year" id="year"></div>
    </div>
  </div>
  <div class="controls">
    <button id="prev">‚èÆ</button>
    <button id="play">‚ñ∂</button>
    <button id="next">‚è≠</button>
    <button id="shuffle">üîÄ</button>
  </div>
  <div class="progress" id="progress"><div class="fill" id="fill"></div></div>
  <div class="playlist" id="playlist"></div>
</div>
<div class="lyrics-box" id="lyrics">Letra carregando...</div>

<script>
const playlistUrl='https://raw.githubusercontent.com/ckrsktx/PlayerX/refs/heads/main/AlternativeNow.json';
let playlistData=[],current=0,audio=new Audio(),playing=false,shuffle=false;

// Elementos
const titleEl=document.getElementById('title');
const artistEl=document.getElementById('artist');
const yearEl=document.getElementById('year');
const coverEl=document.getElementById('cover');
const fill=document.getElementById('fill');
const playBtn=document.getElementById('play');
const shuffleBtn=document.getElementById('shuffle');
const playlistEl=document.getElementById('playlist');
const progress=document.getElementById('progress');
const lyricsEl=document.getElementById('lyrics');

// Pr√©-cache localStorage
async function cacheResource(key,url){
  const cached=localStorage.getItem(key);
  if(cached)return cached;
  try{
    const res=await fetch(url);
    const blob=await res.blob();
    const reader=new FileReader();
    return new Promise(res=>{
      reader.onloadend=()=>{localStorage.setItem(key,reader.result);res(reader.result);}
      reader.readAsDataURL(blob);
    });
  }catch{return null;}
}

// Playlist
async function loadPlaylist(){
  try{
    const res=await fetch(playlistUrl);
    playlistData=await res.json();
    renderPlaylist();
    // Pr√©-cache m√∫sicas
    for(const track of playlistData){
      cacheResource(`audio_${track.title}`,track.url);
    }
    loadTrack(0);
  }catch(e){titleEl.textContent="Erro ao carregar playlist";}
}
function renderPlaylist(){
  playlistEl.innerHTML='';
  playlistData.forEach((track,i)=>{
    const div=document.createElement('div');
    div.textContent=`${track.title} - ${track.artist}`;
    div.onclick=()=>{loadTrack(i);audio.play();playing=true;playBtn.textContent='‚è∏';};
    playlistEl.appendChild(div);
  });
}
function highlight(){
  [...playlistEl.children].forEach((el,i)=>el.classList.toggle('active',i===current));
  playlistEl.children[current]?.scrollIntoView({behavior:"smooth",block:"center"});
}

// Capas via iTunes
async function fetchCover(title,artist){
  const cacheKey=`cover_${title}_${artist}`;
  let cached=localStorage.getItem(cacheKey);
  if(cached){coverEl.style.backgroundImage=`url(${cached})`;return;}
  try{
    const res=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist+" "+title)}&entity=song&limit=1`);
    const data=await res.json();
    if(data.results.length){
      const url=data.results[0].artworkUrl100;
      coverEl.style.backgroundImage=`url(${url})`;
      localStorage.setItem(cacheKey,url);
      yearEl.textContent=new Date(data.results[0].releaseDate).getFullYear();
    }else{
      coverEl.style.backgroundImage="url('https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png')";
      yearEl.textContent="";
    }
  }catch{
    coverEl.style.backgroundImage="url('https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png')";
    yearEl.textContent="";
  }
}

// Letras
async function fetchLyrics(title,artist){
  const cacheKey=`lyrics_${artist}_${title}`;
  const cached=localStorage.getItem(cacheKey);
  if(cached){lyricsEl.textContent=cached;return;}
  lyricsEl.textContent="Carregando letra...";
  try{
    const res=await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
    const data=await res.json();
    if(data.lyrics){
      lyricsEl.textContent=data.lyrics;
      localStorage.setItem(cacheKey,data.lyrics);
    } else { lyricsEl.textContent="Letra n√£o dispon√≠vel.";}
  }catch{lyricsEl.textContent="Erro ao carregar letra.";}
}

// Carregar faixa
async function loadTrack(i){
  current=i;
  const track=playlistData[i];
  audio.src=track.url;
  titleEl.textContent=track.title;
  artistEl.textContent=track.artist;
  yearEl.textContent="";
  highlight();
  fetchCover(track.title,track.artist);
  fetchLyrics(track.title,track.artist);
  document.title=`${track.title} - ${track.artist}`;
  setMediaSession(track);
}

// Controles
playBtn.onclick=()=>{
  if(!playing){audio.play();playing=true;playBtn.textContent='‚è∏';}
  else{audio.pause();playing=false;playBtn.textContent='‚ñ∂';}
};
document.getElementById('prev').onclick=()=>{loadTrack((current-1+playlistData.length)%playlistData.length);audio.play();playing=true;playBtn.textContent='‚è∏';};
document.getElementById('next').onclick=()=>{
  if(shuffle){loadTrack(Math.floor(Math.random()*playlistData.length));}
  else{loadTrack((current+1)%playlistData.length);}
  audio.play();playing=true;playBtn.textContent='‚è∏';
};
shuffleBtn.onclick=()=>{
  shuffle=!shuffle;
  shuffleBtn.style.background=shuffle?"#0f0":"#e0e0e0";
};

// Barra de progresso
progress.onclick=(e)=>{
  const percent=e.offsetX/progress.clientWidth;
  audio.currentTime=percent*audio.duration;
};
audio.ontimeupdate=()=>fill.style.width=(audio.currentTime/audio.duration*100||0)+'%';
audio.onended=()=>document.getElementById('next').click();

// MediaSession API
function setMediaSession(track){
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title,
      artist: track.artist,
      artwork: [{ src: coverEl.style.backgroundImage.slice(5,-2), sizes:"96x96", type:"image/png" }]
    });
    navigator.mediaSession.setActionHandler('play',()=>audio.play());
    navigator.mediaSession.setActionHandler('pause',()=>audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack',()=>document.getElementById('prev').click());
    navigator.mediaSession.setActionHandler('nexttrack',()=>document.getElementById('next').click());
  }
}

// Registrar SW para PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Worker registrado'));
}

loadPlaylist();
</script>
</body>
</html>
